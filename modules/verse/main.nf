#!/usr/bin/env nextflow

// This process uses verse to count features (genes) from a BAM file
// based on the provided GTF annotation file.

process VERSE {
    label 'process_medium' // Counting is less resource-intensive than alignment
    container 'ghcr.io/bf528/verse:latest' 
    
    // Expect only the two files that main.nf is sending: BAM and GTF
    input:
    tuple path(bam_file), path(gtf_file)
    
    output:
    // Use the base name from the input path to define the required output files.
    // FIX: Using a wildcard * to capture the main counts file, 
    // in case VERSE adds an unexpected suffix (e.g., .log) that Nextflow misses.
    path "${bam_file.getBaseName().split('\\.')[0]}.counts*", emit: counts
    
    // FIX: Explicitly check for the common summary file generated by feature-counting tools.
    path "${bam_file.getBaseName().split('\\.')[0]}.counts.summary", optional: true, emit: counts_summary

    script:
    // Define the name variable here ONLY for use in the shell script's -o flag
    def name = bam_file.getBaseName().split('\\.')[0]

    """
    # VERSE command for quantifying reads over exons (gene feature type)
    # -S: Input BAM file
    # -a: Annotation file (GTF)
    # -o: Output file name 
    verse -t gene -S ${bam_file} -a ${gtf_file} -o ${name}.counts
    """
}
